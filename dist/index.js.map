{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import { Controller } from '@hotwired/stimulus';\n\nexport default class extends Controller {\n  static targets = ['content', 'paging', 'loading'];\n  static values = {\n    nextLink: String,\n    margin: { type: Number, default: 5 }\n  };\n\n  static nextLink = 'a.next';\n\n  run(e) {\n    let target = e.target == document || e.target == window ? document.documentElement : this.element\n    if (this.scrolled(target)) this.load();\n  }\n\n  scrolled(element) {\n    let scrollTop = element.scrollTop;\n    let scrollHeight = element.scrollHeight;\n    let contentHeight = element.clientHeight;\n    return scrollTop + contentHeight + this.marginValue >= scrollHeight;\n  }\n\n  load() {\n    let link = this.pagingTarget.querySelector(this.nextLinkValue || this.constructor.nextLink);\n    if (!link) return;\n\n    this.nextHref = link.getAttribute('href');\n    if (!this.nextHref) return;\n\n    if (this.loading) return;\n\n    this.fetch();\n  }\n\n  fetch() {\n    this.start();\n    fetch(this.nextHref).then(response => {\n      if (response.ok) {\n        return response.text();\n      } else {\n        throw new Error(`${response.status} ${response.statusText}`);\n      }\n    }).then(html => {\n      this.done(html);\n    }).catch(error => {\n      this.fail(error);\n    }).then(() => {\n      this.end();\n    });\n  }\n\n  start() {\n    this.toggleLoading(true);\n    this.dispatch('start', { detail: { href: this.nextHref } });\n  }\n\n  end() {\n    this.toggleLoading(false);\n    this.dispatch('end', { detail: { href: this.nextHref } });\n  }\n\n  done(html) {\n    const parser = new DOMParser();\n    const doc = parser.parseFromString(html, 'text/html');\n\n    let content = doc.querySelector(`[data-${this.identifier}-target=\"content\"]`);\n    let paging = doc.querySelector(`[data-${this.identifier}-target=\"paging\"]`);\n\n    this.contentTarget.insertAdjacentHTML('beforeend', content.innerHTML);\n    this.pagingTarget.innerHTML = paging.innerHTML;\n\n    this.dispatch('done', { detail: { href: this.nextHref, content: content, paging: paging, html: html } });\n  }\n\n  fail(error) {\n    this.dispatch('fail', { detail: { href: this.nextHref, error: error } });\n  }\n\n  toggleLoading(loading) {\n    this.loading = loading;\n    if (this.hasLoadingTarget) {\n      this.loadingTarget.style.display = loading ? '' : 'none';\n    }\n  }\n}\n"],"names":["Controller","run","e","target","document","window","documentElement","this","element","scrolled","load","scrollTop","clientHeight","marginValue","scrollHeight","link","pagingTarget","querySelector","nextLinkValue","constructor","nextLink","nextHref","getAttribute","loading","fetch","start","then","response","ok","text","Error","status","statusText","html","done","catch","error","fail","end","toggleLoading","dispatch","detail","href","doc","DOMParser","parseFromString","content","identifier","paging","contentTarget","insertAdjacentHTML","innerHTML","hasLoadingTarget","loadingTarget","style","display","targets","values","String","margin","type","Number","default"],"mappings":"oDAE6BA,aAS3BC,IAAIC,GACF,IAAIC,EAASD,EAAEC,QAAUC,UAAYF,EAAEC,QAAUE,OAASD,SAASE,gBAAkBC,KAAKC,QACtFD,KAAKE,SAASN,IAASI,KAAKG,OAGlCD,SAASD,GAIP,OAHgBA,EAAQG,UAEJH,EAAQI,aACOL,KAAKM,aAFrBL,EAAQM,aAK7BJ,OACE,IAAIK,EAAOR,KAAKS,aAAaC,cAAcV,KAAKW,eAAiBX,KAAKY,YAAYC,UAC7EL,IAELR,KAAKc,SAAWN,EAAKO,aAAa,QAC7Bf,KAAKc,WAENd,KAAKgB,SAEThB,KAAKiB,UAGPA,QACEjB,KAAKkB,QACLD,MAAMjB,KAAKc,UAAUK,KAAKC,IACxB,GAAIA,EAASC,GACX,OAAOD,EAASE,OAEhB,UAAUC,MAASH,EAASI,WAAUJ,EAASK,cAEhDN,KAAKO,IACN1B,KAAK2B,KAAKD,KACTE,MAAMC,IACP7B,KAAK8B,KAAKD,KACTV,KAAK,KACNnB,KAAK+B,QAITb,QACElB,KAAKgC,eAAc,GACnBhC,KAAKiC,SAAS,QAAS,CAAEC,OAAQ,CAAEC,KAAMnC,KAAKc,YAGhDiB,MACE/B,KAAKgC,eAAc,GACnBhC,KAAKiC,SAAS,MAAO,CAAEC,OAAQ,CAAEC,KAAMnC,KAAKc,YAG9Ca,KAAKD,GACH,IACMU,GADS,IAAIC,WACAC,gBAAgBZ,EAAM,aAErCa,EAAUH,EAAI1B,uBAAuBV,KAAKwC,iCAC1CC,EAASL,EAAI1B,uBAAuBV,KAAKwC,gCAE7CxC,KAAK0C,cAAcC,mBAAmB,YAAaJ,EAAQK,WAC3D5C,KAAKS,aAAamC,UAAYH,EAAOG,UAErC5C,KAAKiC,SAAS,OAAQ,CAAEC,OAAQ,CAAEC,KAAMnC,KAAKc,SAAUyB,QAASA,EAASE,OAAQA,EAAQf,KAAMA,KAGjGI,KAAKD,GACH7B,KAAKiC,SAAS,OAAQ,CAAEC,OAAQ,CAAEC,KAAMnC,KAAKc,SAAUe,MAAOA,KAGhEG,cAAchB,GACZhB,KAAKgB,QAAUA,EACXhB,KAAK6C,mBACP7C,KAAK8C,cAAcC,MAAMC,QAAUhC,EAAU,GAAK,WA/E/CiC,QAAU,CAAC,UAAW,SAAU,aAChCC,OAAS,CACdrC,SAAUsC,OACVC,OAAQ,CAAEC,KAAMC,OAAQC,QAAS,MAG5B1C,SAAW"}